graph TB
    subgraph "Frontend Layer"
        A["📱 Chat App<br/>(Flask - Port 5001)"]
        B["🤖 Llama Stack<br/>(Port 8321)"]
        C["🧠 Auth Agent<br/>(Custom Provider)"]
    end
    
    subgraph "Authentication Layer"
        D["🔐 Auth Server<br/>(FastAPI - Port 8002)"]
        E["🗄️ SQLite Database<br/>(Users, Roles, Permissions)"]
        F["🔑 Google OAuth<br/>(External)"]
    end
    
    subgraph "MCP Layer"
        G["🛠️ MCP Server<br/>(FastMCP - Port 8001)"]
        H["📁 File System Tools"]
        I["⚡ Command Execution"]
    end
    
    %% User interaction flow
    A -->|"1. User prompt"| A
    A -->|"2. Check auth"| D
    D -->|"3. OAuth flow"| F
    F -->|"4. User consent"| D
    D -->|"5. JWT token"| A
    
    %% Agent processing flow
    A -->|"6. Create/get agent<br/>with Bearer token"| B
    B -->|"7. Initialize<br/>Auth Agent"| C
    
    %% Message processing
    A -->|"8. Send message"| C
    C -->|"9. GPT-4 processing<br/>(via OpenAI)"| C
    C -->|"10. Tool call needed"| G
    
    %% Authentication flow
    G -->|"11. Validate JWT<br/>Authorization: Bearer {token}"| G
    G -->|"12. Check audience<br/>& issuer claims"| G
    G -->|"13. Verify scopes<br/>against tool requirements"| G
    
    %% Tool execution flow
    G -->|"14a. Execute tool<br/>(if authorized)"| H
    G -->|"14b. Execute tool<br/>(if authorized)"| I
    H -->|"15a. Return result"| G
    I -->|"15b. Return result"| G
    
    %% Error handling flow
    G -->|"16. 403 Insufficient Scope<br/>{error_type: insufficient_scope}"| C
    C -->|"17. InsufficientScopeError<br/>with scope details"| A
    A -->|"18. Auto-request<br/>scope upgrade"| D
    
    %% Approval flow
    D -->|"19. Check policy<br/>(auto vs manual)"| E
    D -->|"20a. Auto-approve<br/>new JWT token"| A
    D -->|"20b. Require approval<br/>create request"| E
    E -->|"21. Admin notification"| D
    D -->|"22. Admin approval<br/>via dashboard"| D
    D -->|"23. Issue new token"| A
    
    %% Success flow
    G -->|"24. Tool result<br/>JSON response"| C
    C -->|"25. Incorporate into<br/>LLM response"| C
    C -->|"26. Stream response"| A
    A -->|"27. Display to user"| A
    
    %% Database connections
    D -.->|"User management"| E
    D -.->|"Client credentials"| E
    D -.->|"Approval requests"| E
    
    style A fill:#e3f2fd
    style B fill:#f3e5f5
    style C fill:#e8f5e8
    style D fill:#fff3e0
    style G fill:#fce4ec
    style E fill:#f1f8e9 