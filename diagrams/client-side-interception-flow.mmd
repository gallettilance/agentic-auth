sequenceDiagram
    participant U as User
    participant C as Client
    participant LS as Llama Stack
    participant AS as Auth Server
    participant MCP as MCP Server
    participant K8S as Kubernetes API

    Note over U,K8S: Tool Call Interception & Approval Flow

    U->>C: "List Kubernetes pods"
    C->>LS: Send user message
    LS->>LS: LLM processes request<br/>Decides to call k8s_get_pods tool
    LS->>C: Tool call request:<br/>k8s_get_pods(namespace="default")
    
    Note over C: ğŸ” CLIENT INTERCEPTION POINT
    C->>C: Extract current JWT token<br/>Decode token scopes<br/>Check required scope: k8s:read
    
    alt Token has k8s:read scope
        Note over C: âœ… Authorization Check Passed
        C->>LS: Approve tool execution
        LS->>MCP: Execute k8s_get_pods tool<br/>with JWT token
        MCP->>K8S: API call with passthrough auth
        K8S->>MCP: Return pod list
        MCP->>LS: Tool execution result
        LS->>C: Response with pod data
        C->>U: Display Kubernetes pods
    else Token missing k8s:read scope
        Note over C: âŒ Insufficient Scope
        C->>U: Show approval popup:<br/>"ğŸ”§ Tool: k8s_get_pods"<br/>"ğŸ” Required: k8s:read scope"<br/>"ğŸ“‹ Description: Read Kubernetes resources"<br/>"âš ï¸ Risk: Medium"
        
        alt User approves
            U->>C: Click "Grant Access"
            C->>AS: POST /api/upgrade-scope<br/>{"scope": "k8s:read"}
            AS->>AS: Validate user session<br/>Check approval permissions
            AS->>C: Return upgraded JWT token<br/>with k8s:read scope
            C->>C: Store new token in session
            
            Note over C: ğŸ”„ Retry with new token
            C->>LS: Retry tool execution<br/>with upgraded token
            LS->>MCP: Execute k8s_get_pods tool<br/>with new JWT token
            MCP->>K8S: API call with passthrough auth
            K8S->>MCP: Return pod list
            MCP->>LS: Tool execution result
            LS->>C: Response with pod data
            C->>U: Display Kubernetes pods
        else User denies
            U->>C: Click "Deny"
            C->>LS: Cancel tool execution
            LS->>C: Tool execution cancelled
            C->>U: "Tool access denied.<br/>Cannot list Kubernetes pods."
        end
    end 