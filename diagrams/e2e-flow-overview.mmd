graph TD
    A["ğŸ‘¤ User enters prompt in<br/>Chat App (Flask)"] --> B["ğŸ” Chat App checks<br/>user authentication"]
    
    B --> C{"ğŸ” User authenticated?"}
    C -->|No| D["ğŸ”„ Redirect to<br/>Google OAuth login"]
    D --> E["ğŸ”‘ Google OAuth flow<br/>via Auth Server"]
    E --> F["âœ… Auth Server creates<br/>JWT token with scopes"]
    F --> G["ğŸ’¾ Store session &<br/>return to chat"]
    G --> B
    
    C -->|Yes| H["ğŸ¤– Get/Create Llama Stack<br/>Agent for user"]
    H --> I["ğŸ“¤ Send message to<br/>Auth Agent (Llama Stack)"]
    
    I --> J["ğŸ§  Auth Agent processes<br/>message with GPT-4"]
    J --> K{"ğŸ”§ Does response<br/>require tool use?"}
    
    K -->|No| L["ğŸ’¬ Return text response<br/>directly to user"]
    
    K -->|Yes| M["ğŸ› ï¸ Auth Agent identifies<br/>required MCP tool"]
    M --> N["ğŸ“¡ Auth Agent calls<br/>MCP Server via HTTP"]
    
    N --> O["ğŸ” MCP Server validates<br/>JWT token"]
    O --> P{"âœ… Token valid &<br/>has required scope?"}
    
    P -->|No - Invalid Token| Q["âŒ Return 401<br/>Unauthorized"]
    Q --> R["ğŸ”„ Auth Agent handles<br/>token refresh"]
    R --> N
    
    P -->|No - Insufficient Scope| S["âŒ Return 403<br/>Forbidden"]
    S --> T["âš ï¸ Auth Agent raises<br/>InsufficientScopeError"]
    T --> U["ğŸ“‹ Chat App detects<br/>authorization error"]
    U --> V["ğŸ”„ Auto-request scope<br/>upgrade from Auth Server"]
    
    V --> W["ğŸ›ï¸ Auth Server evaluates<br/>approval policy"]
    W --> X{"ğŸ¤” Auto-approve or<br/>require admin approval?"}
    
    X -->|Auto-approve| Y["âœ… Auth Server issues<br/>new token with scope"]
    Y --> Z["ğŸ”„ Chat App retries<br/>with new token"]
    Z --> N
    
    X -->|Admin required| AA["â³ Create approval<br/>request in database"]
    AA --> BB["ğŸ“§ Notify admin<br/>(email/dashboard)"]
    BB --> CC["â³ Wait for admin<br/>approval/denial"]
    CC --> DD{"ğŸ‘¨â€ğŸ’¼ Admin decision?"}
    
    DD -->|Approved| Y
    DD -->|Denied| EE["âŒ Show denial message<br/>to user"]
    
    P -->|Yes| FF["ğŸ”§ MCP Server executes<br/>tool (list_files, execute_command, etc.)"]
    FF --> GG["ğŸ“Š Return tool result<br/>to Auth Agent"]
    GG --> HH["ğŸ§  Auth Agent incorporates<br/>result into response"]
    HH --> II["ğŸ’¬ Stream final response<br/>to Chat App"]
    II --> JJ["ğŸ“± Display response<br/>to user"]
    
    style A fill:#e1f5fe
    style L fill:#c8e6c9
    style JJ fill:#c8e6c9
    style EE fill:#ffcdd2
    style Q fill:#ffcdd2
    style S fill:#ffcdd2 