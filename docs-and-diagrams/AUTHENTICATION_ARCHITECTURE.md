# Authentication Architecture

## Overview

This system implements a comprehensive authentication and authorization flow across multiple layers:
- **Client Application** (chat-ui)
- **Llama Stack** (AI agent platform)
- **Auth Server** (centralized authentication/authorization)
- **MCP Servers** (Model Context Protocol tool providers)

## Architecture Flow

### 1. Initial Configuration

**Llama Stack Configuration:**
- Configured to require authentication for API access
- **TODO**: Expose auth server requirements via public endpoint (similar to `/.well-known/oauth-protected-resource`)

### 2. Client Authentication (OAuth Flow)

**Client App Requirements:**
- Uses OAuth 2.0 for user authentication
- Discovers auth requirements during callback

**OAuth Callback Process:**
1. **Service Discovery**: Discover auth server requirements for Llama Stack using public endpoint
2. **Token Generation**: Obtain JWT token from auth server for Llama Stack access

### 3. Llama Stack Access Token

**JWT Token Characteristics:**
- Generated by auth server specifically for Llama Stack audience
- Currently determines basic access permissions
- **⚠️ Security Gap**: No granular API access control - authenticated users can access any Llama Stack endpoint

**Security Risk:**
> Users may gain unrestricted access to call any/all Llama Stack endpoints directly, including:
> - Creating new agents
> - Querying LLM directly
> - Bypassing intended application flow

### 4. MCP Server Discovery

**Discovery Process:**
- Client app uses Llama Stack token to query `/v1/toolgroups`
- Discovers available MCP servers from toolgroup configurations
- Extracts MCP server URLs from `mcp_endpoint.uri` fields

### 5. MCP Authentication Setup

**Service Discovery per MCP Server:**
- Query each MCP server's `/.well-known/oauth-protected-resource` endpoint
- Automatically provided by [FastMCP PR #1113](https://github.com/jlowin/fastmcp/pull/1113)
- Discover auth server and supported scopes for each MCP server

**Initial MCP Token Generation:**
- Request JWT tokens for each discovered MCP server
- **Initial tokens have empty scope** (basic access only)
- Tokens stored in auth server database
- If access denied, user can request permissions through approval flow

### 6. Agent Creation with Authentication Context

**Llama Stack Client Setup:**
- Agent created without MCP tokens initially
- MCP tokens passed during turn creation, not agent creation
- Modified Llama Stack for resilience: [llama-stack PR #1](https://github.com/gallettilance/llama-stack/pull/1/files)

**Key Innovation:**
> MCP tokens passed via headers during agent turn creation
> Tool indexing happens at turn time for auth-required MCPs

### 7. Agent Turn Execution

**Authentication Headers:**
- MCP tokens passed via `X-LlamaStack-Provider-Data` headers
- Llama Stack refreshes available tools based on provided tokens
- Tools added to LLM context dynamically

**Result:**
> ✅ User is authenticated across all layers at this point

### 8. Tool Execution with Scope-Based Authorization

**Initial Tool Call:**
- User prompt triggers tool usage
- Llama Stack receives MCP token with **empty scope**
- MCP server validates token and required scopes

**Authorization Validation:**
- [FastMCP PR #1113](https://github.com/jlowin/fastmcp/pull/1113) provides:
  - Automatic token validation
  - Scope requirement definition per tool
  - Built-in verification (avoiding custom error-prone logic)
  - Authorization errors for insufficient scope

### 9. Dynamic Scope Upgrade Flow

**Authorization Error Handling:**
1. **MCP Server**: Raises authorization error for insufficient scope
2. **Llama Stack**: Catches error and propagates to client app
3. **Client App**: Parses error and requests scope upgrade from auth server

**Scope Upgrade Process:**
- Request token with required scope from auth server
- **Auto-approval**: If user has permissions
- **User Consent**: If additional consent required
- **Admin Approval**: If elevated permissions needed

**Retry Mechanism:**
- Prompt retried with upgraded token after approval
- Seamless user experience for approved requests

### 10. Administrative Oversight

**Admin Notification:**
- Auth server admin notified for denied requests
- Approval workflow for sensitive scopes
- Audit trail for all permission escalations

## Security Features

### ✅ Implemented Security
- **Multi-layer authentication** across all components
- **Scope-based authorization** for MCP tools
- **Dynamic permission escalation** with approval flows
- **Centralized auth server** for consistent policy enforcement
- **Service discovery** preventing hardcoded configurations
- **Token validation** built into FastMCP framework

### ⚠️ Security Gaps
- **Llama Stack API access**: No granular authorization on Llama Stack endpoints
- **Direct API usage**: Authenticated users can bypass application flow
- **Token scope expansion**: Need monitoring for scope creep

## Technology Stack

- **OAuth 2.0**: User authentication
- **JWT**: Inter-service authentication
- **FastMCP**: MCP server framework with built-in auth
- **RFC 9728**: OAuth Protected Resource Discovery
- **Llama Stack**: AI agent platform
- **Python/FastAPI**: Auth server implementation
- **React/Flask**: Client application

## Future Improvements

1. **Llama Stack Authorization**: Implement granular API access control
2. **Auth Server Discovery**: Standardize auth server discovery for Llama Stack
3. **Scope Monitoring**: Implement scope usage analytics and alerts
4. **Token Lifecycle**: Add token refresh and revocation mechanisms
5. **Audit Logging**: Comprehensive audit trail across all components 